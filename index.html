<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Order Tracker ‚Äî RK KNIT FAB</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Themes */
  body.dark{
    background:
      radial-gradient(1200px 600px at 10% -10%, #7dd3fc44, transparent),
      radial-gradient(1000px 600px at 110% 10%, #c084fc33, transparent),
      linear-gradient(180deg,#0b1220,#0b1220 40%,#0e1426 100%);
    color:#e2e8f0;
  }
  body.light{ background:#f7fbff; color:#0f172a; }

  .glass.dark{ backdrop-filter: blur(12px); background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); }
  .glass.light{ background:#ffffffee; backdrop-filter: blur(10px); border:1px solid #e2e8f0; box-shadow:0 10px 25px rgba(2,132,199,.06); }

  /* Chips */
  .chip{ padding:.22rem .65rem; border-radius:9999px; font-weight:700; font-size:.72rem; letter-spacing:.02em }
  .st-process{ color:#e5f2ff; background:#1d4ed8; }
  .st-ready{ color:#052e18; background:#34d399; }
  .st-delayed{ color:#3b0a0a; background:#fca5a5; }
  .st-dispatched{ color:#081225; background:#93c5fd; }

  /* Animations */
  @keyframes spin{ to{ transform:rotate(360deg);} }
  @keyframes pulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.08);} }
  @keyframes shake{ 0%,100%{transform:translateX(0);} 25%{transform:translateX(-4px);} 75%{transform:translateX(4px);} }
  @keyframes drive{ 0%{transform:translateX(-14px);} 100%{transform:translateX(14px);} }

  .ico-gear{ animation: spin 1.4s linear infinite; }
  .ico-check{ animation: pulse 1.6s ease-in-out infinite; transform-origin:center; }
  .ico-clock{ animation: shake 1.2s ease-in-out infinite; }
  .ico-truck{ animation: drive 1.2s ease-in-out infinite alternate; }

  @keyframes fadeSlide{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
  .fade-in{ animation: fadeSlide .45s ease both; }

  .card-sep{ border-color: rgba(255,255,255,.12); }
  body.light .card-sep{ border-color:#e5e7eb; }

  /* Controls */
  .ctrl{ height: 44px; }
  .tag{ padding:.25rem .6rem; border-radius:9999px; font-size:.72rem; border:1px solid #ffffff22 }
  body.light .tag{ border-color:#e5e7eb }
</style>
</head>

<body class="dark min-h-screen transition-colors duration-300">

<header class="max-w-6xl mx-auto px-4 pt-10 pb-6">
  <div class="flex items-center justify-between gap-3">
    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">
      üßµ RK KNIT FAB ‚Äî <span class="text-sky-300 dark:text-sky-300 light:text-sky-700">Order Tracker</span>
    </h1>
    <div class="flex items-center gap-2">
      <button id="themeToggle" class="px-4 py-2 rounded-xl glass dark hover:bg-white/10 light:hover:bg-slate-200 transition text-sm">üåô Dark</button>
      <a href="#" class="text-xs opacity-70 hover:opacity-100">Hosted on GitHub Pages</a>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 pb-20">

  <!-- Filters (Customer/Party input removed) -->
  <section id="filtersCard" class="glass dark rounded-3xl p-6 sm:p-8 shadow-2xl transition">
    <div class="grid sm:grid-cols-6 gap-3 items-end">
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">Item</label>
        <select id="fItem" class="ctrl w-full glass dark rounded-2xl px-3 outline-none"></select>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">Colour</label>
        <select id="fColour" class="ctrl w-full glass dark rounded-2xl px-3 outline-none"></select>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">Status</label>
        <select id="fStatus" class="ctrl w-full glass dark rounded-2xl px-3 outline-none">
          <option value="">All</option>
          <option>IN PROCESS</option>
          <option>READY</option>
          <option>DELAYED</option>
          <option>DISPATCHED</option>
        </select>
      </div>

      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">PI No</label>
        <select id="fPI" class="ctrl w-full glass dark rounded-2xl px-3 outline-none"></select>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">From</label>
        <input type="date" id="fFrom" class="ctrl w-full glass dark rounded-2xl px-3 outline-none" />
      </div>
      <div class="sm:col-span-2">
        <label class="block text-xs mb-1 opacity-80">To</label>
        <input type="date" id="fTo" class="ctrl w-full glass dark rounded-2xl px-3 outline-none" />
      </div>

      <div class="sm:col-span-4">
        <label class="block text-xs mb-1 opacity-80">Search (Item / Colour / PI / Remarks)</label>
        <input id="fSearch" class="ctrl w-full glass dark rounded-2xl px-4 outline-none" placeholder="Type to search‚Ä¶" />
      </div>
      <div class="sm:col-span-2">
        <button id="btnClear" class="w-full ctrl rounded-2xl bg-slate-200/20 hover:bg-slate-200/30 text-sm font-semibold transition glass dark">Clear Filters</button>
      </div>
    </div>
    <p class="text-xs mt-2 opacity-70">Use filters for Easy Data Tracking</p>
  </section>

  <!-- Summary -->
  <section id="summary" class="mt-6 hidden fade-in"></section>

  <!-- Active Results -->
  <section id="results" class="mt-4 space-y-4"></section>

  <!-- Loader -->
  <div id="loader" class="mt-10 flex items-center gap-3 opacity-80 hidden">
    <svg class="ico-gear" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Z" stroke="currentColor" stroke-width="1.8"/>
      <path d="M4 12h2M18 12h2M12 4v2M12 18v2M17 7l-1.4 1.4M8.4 16.6 7 18M7 7l1.4 1.4M16.6 16.6 18 18" stroke="currentColor" stroke-width="1.8"/>
    </svg>
    <span>Loading‚Ä¶</span>
  </div>

</main>

<footer class="max-w-6xl mx-auto px-4 pb-10 text-xs opacity-60">¬© RK KNIT FAB ‚Äî Live Status</footer>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbzFljZhpwmAR-BANlmSYbtvCC36T0qyrbcMUGbQc8f4RBDi8jIIR39YJzaAZMS5dqBa/exec';

/* ===== THEME ===== */
const body = document.body, btnTheme = document.getElementById('themeToggle');
function applyTheme(t){
  body.classList.remove('dark','light'); body.classList.add(t);
  document.querySelectorAll('.glass').forEach(el=>{ el.classList.remove('dark','light'); el.classList.add(t); });
  btnTheme.textContent = t==='dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
  localStorage.setItem('theme',t);
}
applyTheme(localStorage.getItem('theme') || 'dark');
btnTheme.addEventListener('click', ()=> applyTheme(body.classList.contains('dark') ? 'light' : 'dark'));

/* ===== ELEMENTS ===== */
const els = {
  results: document.getElementById('results'),
  loader: document.getElementById('loader'),
  summary: document.getElementById('summary'),
  fItem: document.getElementById('fItem'),
  fColour: document.getElementById('fColour'),
  fStatus: document.getElementById('fStatus'),
  fPI: document.getElementById('fPI'),
  fFrom: document.getElementById('fFrom'),
  fTo: document.getElementById('fTo'),
  fSearch: document.getElementById('fSearch'),
  btnClear: document.getElementById('btnClear'),
};

/* ===== ICONS ===== */
function iconSVG(kind, size=22){
  if (kind==='check') return `<svg class="ico-check" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 7L10 17l-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  if (kind==='clock') return `<svg class="ico-clock" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="8.5" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
  if (kind==='truck') return `<svg class="ico-truck" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M2 7h11v8H2zM13 10h4l3 3v2h-7" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="6" cy="17" r="2" stroke="currentColor" stroke-width="2"/><circle cx="17" cy="17" r="2" stroke="currentColor" stroke-width="2"/></svg>`;
  return `<svg class="ico-gear" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7Z" stroke="currentColor" stroke-width="1.8"/><path d="M4 12h2M18 12h2M12 4v2M12 18v2M17 7l-1.4 1.4M8.4 16.6 7 18M7 7l1.4 1.4M16.6 16.6 18 18" stroke="currentColor" stroke-width="1.8"/></svg>`;
}

/* ===== HELPERS ===== */
function statusMeta(s){
  const t=(s||'').toString().trim().toUpperCase();
  if (t==='READY') return {label:'READY', chip:'st-ready', icon:'check'};
  if (t==='DELAYED') return {label:'DELAYED', chip:'st-delayed', icon:'clock'};
  if (t==='DISPATCHED') return {label:'DISPATCHED', chip:'st-dispatched', icon:'truck'};
  return {label:'IN PROCESS', chip:'st-process', icon:'gear'};
}
function fmtDate(v){ if(!v) return ''; const d=new Date(v); return isNaN(d)?v:d.toLocaleDateString(); }
function groupByPI(rows){ const m={}; rows.forEach(r=>{ const k=r['PI_No']||'NO-PI'; (m[k]=m[k]||[]).push(r);}); return m; }
function unique(list){ return Array.from(new Set(list.filter(x=>x!=null && x!==''))).sort((a,b)=>String(a).localeCompare(String(b))); }

/* ===== PARTY KEY FROM URL (hidden, no UI) ===== */
const params = new URLSearchParams(location.search);
const partyKey = (params.get('party') || '').trim().toUpperCase();

/* ===== DATA STATE ===== */
let masterRows = []; // all rows for this party
let filteredRows = []; // rows after filters

/* ===== LOAD DATA ===== */
async function load(){
  if (!partyKey){
    els.results.innerHTML = `<div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-3xl p-6 text-rose-400 text-center text-lg">‚ùå Personal link missing. Contact support.</div>`;
    return;
  }
  els.results.innerHTML=''; els.summary.classList.add('hidden'); els.loader.classList.remove('hidden');
  try{
    const url=new URL(API); url.searchParams.set('party', partyKey);
    const res=await fetch(url.toString(),{mode:'cors'});
    const json=await res.json();
    if (json.error){
      els.results.innerHTML = `<div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-2xl p-6 text-rose-400 text-center text-lg">‚ùå ${json.error}</div>`;
      return;
    }
    masterRows = json.data || [];
    buildFilters(masterRows);
    applyFilters(); // sets filteredRows + render
    // Summary
    const totalQty = masterRows.reduce((s,r)=> s + (Number(r['Qty'])||0), 0);
    els.summary.innerHTML = `
      <div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-3xl p-5 grid sm:grid-cols-3 gap-4">
        <div><div class="text-xs opacity-70">Party</div><div class="text-lg font-semibold">${json.party_name||'-'}</div></div>
        <div><div class="text-xs opacity-70">Records</div><div class="text-lg font-semibold">${masterRows.length}</div></div>
        <div><div class="text-xs opacity-70">Total Qty</div><div class="text-lg font-semibold">${totalQty}</div></div>
      </div>`;
    els.summary.classList.remove('hidden');
  }catch(e){
    els.results.innerHTML = `<div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-2xl p-6 text-rose-400">Error loading data.</div>`;
  }finally{
    els.loader.classList.add('hidden');
  }
}

/* ===== BUILD FILTERS ===== */
function setOptions(sel, values, includeAll=true, labelAll='All'){
  const cur = sel.value;
  sel.innerHTML = '';
  if (includeAll) sel.innerHTML += `<option value="">${labelAll}</option>`;
  values.forEach(v => sel.innerHTML += `<option>${String(v)}</option>`);
  // try keep previous selection
  const has = Array.from(sel.options).some(o=>o.value===cur);
  if (has) sel.value = cur;
}
function buildFilters(rows){
  setOptions(els.fItem, unique(rows.map(r=>r['Item'])));
  setOptions(els.fColour, unique(rows.map(r=>r['Colour'])));
  setOptions(els.fPI, unique(rows.map(r=>r['PI_No'])));
}

/* ===== APPLY FILTERS ===== */
function normalize(str){ return (str||'').toString().toLowerCase(); }
function applyFilters(){
  const vItem = els.fItem.value;
  const vColour = els.fColour.value;
  const vStatus = els.fStatus.value;
  const vPI = els.fPI.value;
  const vFrom = els.fFrom.value ? new Date(els.fFrom.value) : null;
  const vTo = els.fTo.value ? new Date(els.fTo.value) : null;
  const q = normalize(els.fSearch.value);

  filteredRows = masterRows.filter(r=>{
    if (vItem && String(r['Item'])!==vItem) return false;
    if (vColour && String(r['Colour'])!==vColour) return false;
    if (vStatus && statusMeta(r['Status']).label !== vStatus) return false;
    if (vPI && String(r['PI_No'])!==vPI) return false;

    // Date range on r['Date']
    if (vFrom || vTo){
      const d = r['Date'] ? new Date(r['Date']) : null;
      if (!d || isNaN(d)) return false;
      if (vFrom && d < vFrom) return false;
      if (vTo && d > vTo) return false;
    }

    if (q){
      const hay = [
        r['Item'], r['Colour'], r['PI_No'], r['Status'], r['Remarks']
      ].map(normalize).join(' ');
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  render(filteredRows);
}

/* ===== RENDER ===== */
function render(rows){
  if (!rows.length){
    els.results.innerHTML = `
      <div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-2xl p-8 flex items-center gap-4">
        ${iconSVG('clock',26)}
        <div>
          <div class="font-semibold">No matching records</div>
          <div class="text-sm opacity-70">Adjust filters to see results.</div>
        </div>
      </div>`;
    return;
  }

  const groups = groupByPI(rows);
  els.results.innerHTML = Object.keys(groups).map(pi=>{
    const items = groups[pi];
    const head = items[0];
    const expected = head['Expected_Delivery'] ? fmtDate(head['Expected_Delivery']) : '-';
    const lastUpd = head['Last_Updated'] ? fmtDate(head['Last_Updated']) : '-';

    const rowsHtml = items.map(r=>{
      const m=statusMeta(r['Status']);
      return `
        <div class="grid grid-cols-12 items-center py-3 px-3 rounded-xl hover:bg-white/5 transition fade-in">
          <div class="col-span-5 md:col-span-4 flex items-center gap-3">
            <div class="w-7 h-7 flex items-center justify-center">${iconSVG(m.icon,22)}</div>
            <div>
              <div class="font-medium">${r['Item']||'-'}</div>
              <div class="text-xs opacity-60">${r['Colour']||'-'}</div>
            </div>
          </div>
          <div class="col-span-3 md:col-span-3 text-sm">${fmtDate(r['Date'])}</div>
          <div class="col-span-2 md:col-span-2 text-sm">${r['Qty']||'-'}</div>
          <div class="col-span-2 md:col-span-3"><span class="chip ${m.chip}">${m.label}</span></div>
        </div>`;
    }).join('');

    return `
      <div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-3xl overflow-hidden fade-in">
        <div class="p-5 sm:p-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 border-b card-sep">
          <div class="flex items-center gap-3">
            <div class="text-xl font-bold tracking-wide">PI: ${pi}</div>
            <div class="text-xs opacity-70">Expected: ${expected}</div>
          </div>
          <div class="text-xs opacity-60">Last Updated: ${lastUpd}</div>
        </div>
        <div class="p-3 divide-y card-sep">
          <div class="grid grid-cols-12 px-3 py-2 text-xs uppercase tracking-wider opacity-60">
            <div class="col-span-5 md:col-span-4">Item</div>
            <div class="col-span-3 md:col-span-3">Date</div>
            <div class="col-span-2 md:col-span-2">Qty</div>
            <div class="col-span-2 md:col-span-3">Status</div>
          </div>
          ${rowsHtml}
        </div>
      </div>`;
  }).join('');
}

/* ===== EVENTS ===== */
['change','input'].forEach(ev=>{
  els.fItem.addEventListener(ev, applyFilters);
  els.fColour.addEventListener(ev, applyFilters);
  els.fStatus.addEventListener(ev, applyFilters);
  els.fPI.addEventListener(ev, applyFilters);
  els.fFrom.addEventListener(ev, applyFilters);
  els.fTo.addEventListener(ev, applyFilters);
  els.fSearch.addEventListener(ev, debounce(applyFilters, 200));
});
els.btnClear.addEventListener('click', ()=>{
  els.fItem.value = '';
  els.fColour.value = '';
  els.fStatus.value = '';
  els.fPI.value = '';
  els.fFrom.value = '';
  els.fTo.value = '';
  els.fSearch.value = '';
  applyFilters();
});

/* ===== Debounce ===== */
function debounce(fn, delay){
  let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };
}

/* ===== INIT ===== */
if (partyKey) load();
else {
  els.results.innerHTML = `<div class="glass ${body.classList.contains('dark')?'dark':'light'} rounded-3xl p-6 text-rose-400 text-center text-lg">‚ùå Personal link missing. Contact support.</div>`;
}
</script>

</body>
</html>
